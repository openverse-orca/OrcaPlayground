{
  "description": "SPlisHSPlasH 配置文件模板 (用于生成SPH程序配置)",
  
  "orcalink_client": {
    "enabled": true,
    "server_address": "localhost:50351",
    "session_id": 1,
    "client_name": "SPlisHSPlasH",
    "update_rate_hz": 50,
    "encoding": {
      "i_frame_interval": 30,
      "change_threshold": 0.001
    },
    "session": {
      "control_mode": "sync",
      "expected_clients": 2,
      "ready_timeout_sec": 30.0,
      "grpc_call_timeout_sec": 5.0,
      "async_params": {
        "flow_control_enabled": true,
        "flow_control_window_size": 10,
        "speed_ratio_threshold": 2.0
      },
      "sync_params": {
        "sync_window_size": 2
      }
    }
  },
  
  "orcalink_bridge": {
    "coupling_mode": "multi_point_force",
    "spring_constraint": {
      "channels": {
        "position": {
          "channel_id": 2,
          "publish": true,
          "subscribe": true,
          "comment": "SPH接收位置来自MuJoCo"
        }
      },
      "anchor_particles": {
        "actuator_type": "spring_force",
        "comment": "actuator_type: spring_force=弹簧力, pd_controller=PD控制器"
      },
      "rigid_body_dynamics": {
        "mode": "internal",
        "force_smoothing_alpha": 0.3,
        "comment": "mode: internal=SPH内部PBD处理动力学+Mujoco参与, external=Mujoco完全负责动力学。force_smoothing_alpha: EMA平滑系数[0,1]，推荐0.3（约3个周期平滑），避免力脉冲导致刚体被弹飞。两种模式都将平滑后的力发送给Mujoco参与动力学计算"
      },
      "force_clamping": {
        "enabled": true,
        "rigid_body": {
          "enabled": true,
          "max_acceleration_g": 10.0,
          "discard_on_clamp": true
        },
        "debug": {
          "log_clamped_forces": true,
          "log_threshold_n": 1000.0
        }
      }
    },
    "multi_point_force": {
      "channels": {
        "force": {
          "channel_id": 2,
          "publish": true,
          "subscribe": false,
          "comment": "混合通道：SPH发送force（data_type=FORCE），接收position（data_type=POSITION）"
        },
        "position": {
          "channel_id": 2,
          "publish": false,
          "subscribe": true,
          "comment": "混合通道：与force使用同一通道，通过data_type区分。客户端自动过滤：只发position，只收force"
        }
      },
      "force_decomposition": {
        "precompute_inverse": true,
        "regularization": 1e-8,
        "comment": "regularization降低到1e-8以提高力矩分解精度（原0.001会导致力矩误差>400%）"
      },
      "anchor_particles": {
        "actuator_type": "pd_controller",
        "comment": "actuator_type: spring_force=弹簧力, pd_controller=PD控制器"
      },
      "rigid_body_dynamics": {
        "mode": "internal",
        "force_smoothing_alpha": 0.3,
        "comment": "mode: internal=SPH内部PBD处理动力学+Mujoco参与, external=Mujoco完全负责动力学。force_smoothing_alpha: EMA平滑系数[0,1]，推荐0.3（约3个周期平滑），避免力脉冲导致刚体被弹飞。两种模式都将平滑后的力发送给Mujoco参与动力学计算"
      }
    },
    "shared_modules": {
      "spring_force": {
        "apply_spring_forces": true,
        "auto_tune": true,
        "natural_frequency_hz": 2.0,
        "damping_ratio": 0.2,
        "linear_spring_stiffness": 5000.0,
        "linear_damping_coefficient": 180.0,
        "angular_spring_stiffness": 40.0,
        "angular_damping_coefficient": 2.0,
        "max_spring_force": 5000.0,
        "max_spring_torque": 200.0,
        "position_deadzone": 0.0001,
        "rotation_deadzone": 0.001,
        "estimate_remote_velocity": false,
        "velocity_filter_alpha": 0.3,
        "comment": "弹簧力配置（用于 spring_constraint 模式，仍通过 scene 传递）。完整的弹簧力配置（14个必选参数）。estimate_remote_velocity设为false避免导入velocity_estimator模块错误"
      },
      "pd_controller": {
        "enabled": true,
        "auto_tune": true,
        "natural_frequency_hz": 3.0,
        "damping_ratio": 1.5,
        "Kp": 5000.0,
        "Kd": 500.0,
        "max_force": 5000.0,
        "position_deadzone": 0.0001,
        "velocity_filter_alpha": 0.3,
        "comment": "PD控制器配置（用于multi_point_force模式）。\n\n【自动调参】auto_tune=true时根据锚点粒子质量自动计算Kp和Kd。\n\n【响应速度】natural_frequency_hz控制目标响应频率（Hz）。\n  - 值越大，响应越快，但可能引起振荡\n  - 推荐范围：0.5-2.0 Hz（重物用更低值）\n  - 实际频率补偿：由于锚点通过Ball Joint连接刚体，实际系统频率会降低\n\n【阻尼比】damping_ratio控制阻尼程度：\n  - 1.0 = 临界阻尼（无超调，最快稳定）\n  - <1.0 = 欠阻尼（会振荡）\n  - >1.0 = 过阻尼（响应缓慢）"
      },
      "passivity_control": {
        "enabled": true,
        "auto_tune": true,
        "reference_mass": 1.0,
        "energy_threshold_per_kg": 1.0,
        "max_damping_per_sqrt_kg": 150.0,
        "dissipation_time_constant": 0.2,
        "min_velocity_threshold": 0.01,
        "fluid_force": {
          "enabled": true,
          "auto_tune": true,
          "energy_control": {
            "enabled": true,
            "energy_threshold_per_kg": 10.0,
            "max_force_attenuation": 0.8,
            "velocity_damping_per_sqrt_kg": 22.36,
            "dissipation_time_constant": 0.5,
            "min_velocity_threshold": 0.01
          },
          "force_rate_limit": {
            "enabled": true,
            "max_force_rate_per_kg": 1000.0
          },
          "comment": "流体力无源性控制（用于 multi_point_force 模式）：\n\n【P0: 能量控制】监控流体力注入的能量，超阈值时衰减力并添加阻尼\n  - energy_threshold_per_kg: 单位质量能量阈值(J/kg)\n  - max_force_attenuation: 最大力衰减比例(0-1)\n  - velocity_damping_per_sqrt_kg: 单位√质量阻尼系数\n\n【P1: 力变化率限制】限制流体力变化率，抑制弹力效应\n  - max_force_rate_per_kg: 单位质量最大力变化率((N/s)/kg)\n\n【统计输出】由 debug.enable_fluid_force_stats 控制"
        },
        "comment": "无源性控制：\n\n【锚点PD控制】(第一层PO/PC) 针对锚点位姿跟踪的能量注入控制\n  - 启用 auto_tune 后，能量阈值和最大阻尼会根据刚体质量自动调整\n  - reference_mass 是参考质量(kg)\n  - energy_threshold_per_kg 是单位质量能量阈值(J/kg)\n  - max_damping_per_sqrt_kg 是单位根号质量阻尼系数\n  - 统计信息由 debug.enable_actuator_force_stats 和 stats_log_interval 控制\n\n【流体力控制】(第二层PO/PC) 见 fluid_force 子节配置"
      },
      "gravity": {
        "enable_rigid_body_gravity": false,
        "enable_rigid_body_collision": false,
        "anchor_particle_mass_ratio": 0.5
      },
      "force_clamping": {
        "enabled": true,
        "rigid_body": {
          "enabled": true,
          "max_acceleration_g": 2.0,
          "discard_on_clamp": true
        },
        "debug": {
          "log_clamped_forces": true,
          "log_threshold_n": 1000.0
        }
      },
      "force_inference": {
        "method": "acceleration",
        "smoothing": {
          "ema_filter": {
            "enabled": true,
            "alpha": 0.2
          },
          "rate_limit": {
            "enabled": true,
            "max_force_change_rate": 5000.0,
            "max_torque_change_rate": 100.0
          }
        },
        "comment": "method: 'sph' (direct SPH boundary forces) or 'acceleration' (infer from PBD velocity changes). smoothing: EMA filter and rate limit for acceleration inference."
      }
    }
  },
  
  "physics": {
    "gravity": [0, 0, -9.81],
    "linear_damping": 0.01,
    "angular_damping": 0.01,
    "enable_debug_output": false,
    "physics_dt": 0.001
  },

  "particle_render": {
    "grpc": {
      "server_address": "localhost:50251",
      "enabled": true,
      "update_rate_hz": 20,
      "realtime_sync": true,
      "compression": {
        "enabled": false,
        "show_stats": false
      },
      "quantization": {
        "enabled": true
      },
      "transmission_mode": "particle_frame"
    },
    "voxel_grid": {
      "width": 128,
      "height": 128,
      "depth": 128,
      "voxel_size_ratio": 1.0,
      "origin": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "data_mode": "density_velocity",
      "velocity": {
        "max_speed": 5.0,
        "enabled": true
      },
      "statistics": {
        "enabled": false
      }
    },
    "particle_frame": {
      "grid_resolution": {
        "x": 512,
        "y": 512,
        "z": 512
      },
      "voxel_size_ratio": 1.0,
      "ip_frame": {
        "i_frame_interval": 30,
        "position_threshold": 2,
        "velocity_threshold": 5,
        "change_ratio_threshold": 0.5
      }
    }
  },

  "debug": {
    "verbose_logging": false,
    "enable_actuator_force_stats": true,
    "enable_fluid_force_stats": true,
    "enable_passivity_stats": true,
    "stats_log_interval": 1.0,
    "visualize_anchor_particles": true,
    "visualize_target_positions": true,
    "visualize_actuator_connections": true,
    "anchor_particle_size": 0.02,
    "target_position_size": 0.015,
    "comment": "Debug选项：verbose_logging启用详细日志；enable_actuator_force_stats启用弹簧力/PD控制器统计；enable_fluid_force_stats启用流体力统计；enable_passivity_stats启用无源性控制统计；stats_log_interval统计输出间隔（秒）；visualize_*控制锚点粒子可视化"
  }
}

